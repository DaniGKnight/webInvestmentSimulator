<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
        STEP 1: CUSTOMIZE THIS FILE
        Change the title to the name of your stock. 
    -->
    <title>AAPL Investment Simulator</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #2d3748;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .container {
            max-width: 90vw;
            margin: 0 auto;
        }
        #crosshair-date {
            position: absolute;
            bottom: 0px;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background-color: #4b5563;
            color: white;
            font-size: 12px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        #crosshair-price {
            position: absolute;
            right: 0px;
            top: 50%;
            transform: translateY(-50%);
            padding: 4px 8px;
            background-color: #4b5563;
            color: white;
            font-size: 12px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        #crosshair-close-price {
            position: absolute;
            top: 60px;
            left: 70px;
            padding: 4px 8px;
            background-color: #4b5563;
            color: #fff;
            font-size: 12px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
            font-weight: 600;
        }

        /* Custom table styling for positions and history */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #4b5563;
        }
        th {
            background-color: #374151;
            font-weight: 600;
        }
        tr:hover {
            background-color: #3e4757;
        }

        /* Hide the number input arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        .hidden {
            display: none;
        }
        
        .disabled-btn {
             cursor: not-allowed;
             opacity: 0.5;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">

    <!-- Main container -->
    <div class="container bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-4xl">
        
        <!-- Start Screen -->
        <div id="startScreen" class="flex flex-col items-center justify-center text-center">
            <!-- 
                STEP 2: CUSTOMIZE THIS FILE
                Change the stock name here to match your data.
            -->
            <h1 class="text-3xl sm:text-4xl font-bold mb-4 text-white">AAPL Investment Game</h1>
            <p class="mb-6 text-gray-400">Select your funds and end date to begin the simulation.</p>
            
            <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6 w-full">
                <!-- Funds input -->
                <div class="w-full sm:w-auto flex items-center space-x-2">
                    <label for="startFunds" class="text-sm font-medium text-gray-300 whitespace-nowrap">Start Funds ($):</label>
                    <input type="number" id="startFunds" class="w-24 form-input rounded-lg border-gray-600 bg-gray-700 text-gray-100 p-2 text-center" value="10000" min="1000" step="1000">
                </div>
            </div>

            <!-- Date picker -->
            <div class="w-full sm:w-auto flex items-center space-x-2">
                <label for="datePicker" class="text-sm font-medium text-gray-300 whitespace-nowrap">End Date:</label>
                <input type="date" id="datePicker" class="form-input rounded-lg border-gray-600 bg-gray-700 text-gray-100 p-2 focus:ring-2 focus:ring-violet-500 focus:border-transparent transition-colors duration-200">
            </div>

            <button id="startGameBtn" class="mt-8 px-6 py-3 rounded-full font-bold bg-gray-600 disabled-btn transition-colors" disabled>Start Game</button>
            <div id="startMessageArea" class="mt-4 text-red-400 font-semibold hidden"></div>
        </div>
        
        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <h1 class="text-3xl sm:text-4xl font-bold mb-4 text-center text-white">AAPL Investment Simulator</h1>

            <!-- Button bar above the chart -->
            <div class="flex flex-row justify-end items-center w-full mb-4 space-x-2">
                <!-- Day navigation button -->
                <div class="flex space-x-1 sm:space-x-2 w-full justify-end">
                    <button id="nextDayBtn" class="text-sm sm:text-base flex-1 sm:flex-none px-4 py-2 rounded-full font-bold bg-violet-600 hover:bg-violet-700 transition-colors" disabled>Next Day</button>
                </div>
            </div>
            
            <!-- Chart and message area -->
            <div class="relative w-full h-[300px] sm:h-[500px]">
                <canvas id="chartCanvas" class="w-full h-full"></canvas>
                
                <!-- New element to display the closing price of the day -->
                <div id="crosshair-close-price"></div>
                
                <div id="messageArea" class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-70 rounded-xl transition-opacity duration-300 hidden">
                    <p class="text-lg font-semibold text-white">Loading data...</p>
                </div>
                <!-- Elements to display crosshair info -->
                <div id="crosshair-date"></div>
                <div id="crosshair-price"></div>
            </div>

            <!-- Investment Controls Panel -->
            <div class="bg-gray-700 p-4 sm:p-6 rounded-xl shadow-md mt-6 w-full">
                <h2 class="text-xl font-bold mb-4 text-white">Investment Control</h2>
                <!-- Use a single column layout with wrapping for mobile -->
                <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-2 w-full sm:w-auto justify-center">
                        <label for="investAmount" class="text-sm font-medium text-gray-300 whitespace-nowrap">Max Investment ($):</label>
                        <button id="minusBtn" class="px-2 py-1 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-bold transition-colors">-</button>
                        <input type="number" id="investAmount" class="w-24 form-input rounded-lg border-gray-600 bg-gray-800 text-gray-100 p-2 text-center" value="1000" min="1000" step="1000">
                        <button id="plusBtn" class="px-2 py-1 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-bold transition-colors">+</button>
                    </div>
                    <!-- Buttons are stacked on top of each other on mobile -->
                    <div class="flex flex-row space-x-4 w-full sm:w-auto justify-center mt-4 sm:mt-0">
                        <button id="buyBtn" class="w-full sm:w-auto px-6 py-2 rounded-full font-bold bg-green-600 hover:bg-green-700 transition-colors" disabled>BUY</button>
                        <button id="sellBtn" class="w-full sm:w-auto px-6 py-2 rounded-full font-bold bg-red-600 hover:bg-red-700 transition-colors" disabled>SELL</button>
                    </div>
                </div>
            </div>

            <!-- Portfolio and Summary Panel -->
            <div class="bg-gray-700 p-4 sm:p-6 rounded-xl shadow-md mt-6 w-full">
                <h2 class="text-xl font-bold mb-4 text-white">My Portfolio</h2>
                <!-- Grid columns now become a single column on mobile -->
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Total Invested</p>
                        <p id="totalInvested" class="text-xl font-bold text-gray-100">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Remaining Funds</p>
                        <p id="remainingFunds" class="text-xl font-bold text-gray-100">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Liquidation Value</p>
                        <p id="liquidationValue" class="text-xl font-bold text-gray-100">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Realized P&L</p>
                        <p id="realizedPnL" class="text-xl font-bold text-gray-100">$0.00</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="positionsTable" class="min-w-full text-sm">
                        <thead>
                            <tr>
                                <th>Stock</th>
                                <th>Shares</th>
                                <th>Avg. Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Positions will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- History Panel -->
            <div class="bg-gray-700 p-4 sm:p-6 rounded-xl shadow-md mt-6 w-full">
                <h2 class="text-xl font-bold mb-4 text-white">Transaction History</h2>
                <div class="overflow-x-auto">
                    <table id="historyTable" class="min-w-full text-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Order</th>
                                <th>#</th>
                                <th>Price</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- History will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use an IIFE (Immediately Invoked Function Expression) to avoid global scope pollution
        (function() {
            // --- STEP 3: PASTE YOUR STOCK DATA HERE ---
            //
            // Replace the example data below with the content of your CSV file.
            // Be sure to keep the backticks (`) and the 'symbol,per,date...' header row.
            // This is the single, crucial place you'll change for each new stock file.
            // The data must be in the format:
            // symbol,per,date,time,open,high,low,close,vol,...
            // Example: AAPL,D,20220103,0,177.83,182.88,177.78,182.01,104702000
            
            const rawData = `symbol,per,date,time,open,high,low,close,vol
AAPL.US,D,19840907,000000,0.0996047,0.100827,0.0984022,0.0996047,98811715,0
AAPL.US,D,19840910,000000,0.0996047,0.0999102,0.0972099,0.0990135,76694011,0
AAPL.US,D,19840911,000000,0.0999102,0.10262,0.0999102,0.100827,180849030,0
AAPL.US,D,19840912,000000,0.100827,0.101417,0.0977914,0.0977914,157987052,0
AAPL.US,D,19840913,000000,0.103232,0.103526,0.103232,0.103232,246058991,0
AAPL.US,D,19840914,000000,0.103526,0.107124,0.103526,0.10472,292979204,0
AAPL.US,D,19840917,000000,0.10472,0.10862,0.10472,0.107725,217822986,0
AAPL.US,D,19840918,000000,0.107725,0.1095,0.107725,0.10862,238549079,0
AAPL.US,D,19840919,000000,0.10862,0.111915,0.10862,0.1095,302660143,0
AAPL.US,D,19840920,000000,0.1095,0.111915,0.1095,0.1107,314811097,0
AAPL.US,D,19840921,000000,0.1107,0.1128,0.1107,0.11161,288289063,0
AAPL.US,D,19840924,000000,0.11161,0.11251,0.1107,0.1107,260844979,0
AAPL.US,D,19840925,000000,0.1107,0.1128,0.1107,0.11161,164771092,0
AAPL.US,D,19840926,000000,0.11161,0.113705,0.11161,0.11161,167475141,0
AAPL.US,D,19840927,000000,0.11161,0.111915,0.1107,0.1107,159781896,0
AAPL.US,D,19840928,000000,0.1107,0.111305,0.10891,0.10891,168058913,0
AAPL.US,D,19841001,000000,0.10891,0.1101,0.107725,0.10862,187807185,0
AAPL.US,D,19841002,000000,0.10862,0.1095,0.107725,0.10862,126079040,0
AAPL.US,D,19841003,000000,0.10862,0.1104,0.10862,0.1104,118047020,0
AAPL.US,D,19841004,000000,0.1104,0.111305,0.1104,0.1104,105151028,0
AAPL.US,D,19841005,000000,0.1104,0.11161,0.1101,0.1107,98748986,0
AAPL.US,D,19841008,000000,0.1107,0.1107,0.107725,0.10862,130182885,0
AAPL.US,D,19841009,000000,0.10862,0.1095,0.107415,0.107725,108693899,0
AAPL.US,D,19841010,000000,0.107725,0.10862,0.107725,0.10862,109311400,0
AAPL.US,D,19841011,000000,0.10862,0.1107,0.10862,0.1104,105193910,0
AAPL.US,D,19841012,000000,0.1104,0.1104,0.10862,0.1095,127598858,0
AAPL.US,D,19841015,000000,0.1095,0.111005,0.1095,0.1107,143890820,0
AAPL.US,D,19841016,000000,0.1107,0.111305,0.10891,0.1104,127598858,0
AAPL.US,D,19841017,000000,0.1104,0.1128,0.1104,0.1128,155100067,0
AAPL.US,D,19841018,000000,0.1128,0.11431,0.1128,0.113705,183178051,0
AAPL.US,D,19841019,000000,0.113705,0.113705,0.11161,0.11251,135248817,0
AAPL.US,D,19841022,000000,0.11251,0.1134,0.1107,0.11161,124806037,0
AAPL.US,D,19841023,000000,0.11161,0.1128,0.11161,0.11161,128884024,0
AAPL.US,D,19841024,000000,0.11161,0.1128,0.11161,0.1128,95889006,0
AAPL.US,D,19841025,000000,0.1128,0.113705,0.11161,0.11161,137095945,0
AAPL.US,D,19841026,000000,0.11161,0.11251,0.1104,0.111305,108643039,0
AAPL.US,D,19841029,000000,0.111305,0.111915,0.1098,0.1101,114704047,0
AAPL.US,D,19841030,000000,0.1101,0.1104,0.10862,0.10891,105370997,0
AAPL.US,D,19841031,000000,0.10891,0.10891,0.107415,0.107725,125026048,0`;

            // --- Global State Variables ---
            let allStockData = [];
            let stockData = [];
            let currentIndex = -1;
            let canvas, ctx;
            let chartWidth, chartHeight;
            let dataToDisplay = [];
            let minPrice, maxPrice, priceScale;
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            
            // --- Simulator State Variables ---
            let portfolio = {};
            let transactionHistory = [];
            let totalInvestedAmount = 0;
            let totalRealizedPnL = 0;
            let startFunds = 0;
            let remainingFunds = 0;
            let liquidationValue = 0;

            // --- DOM Elements ---
            const datePicker = document.getElementById('datePicker');
            const nextDayBtn = document.getElementById('nextDayBtn');
            const messageArea = document.getElementById('messageArea');
            const crosshairDateEl = document.getElementById('crosshair-date');
            const crosshairPriceEl = document.getElementById('crosshair-price');
            const crosshairClosePriceEl = document.getElementById('crosshair-close-price');
            
            // Start Screen DOM Elements
            const startScreen = document.getElementById('startScreen');
            const gameScreen = document.getElementById('gameScreen');
            const startFundsInput = document.getElementById('startFunds');
            const startGameBtn = document.getElementById('startGameBtn');
            const startMessageArea = document.getElementById('startMessageArea');

            // Simulator DOM Elements
            const investAmountInput = document.getElementById('investAmount');
            const minusBtn = document.getElementById('minusBtn');
            const plusBtn = document.getElementById('plusBtn');
            const buyBtn = document.getElementById('buyBtn');
            const sellBtn = document.getElementById('sellBtn');
            const totalInvestedEl = document.getElementById('totalInvested');
            const remainingFundsEl = document.getElementById('remainingFunds');
            const liquidationValueEl = document.getElementById('liquidationValue');
            const realizedPnLEl = document.getElementById('realizedPnL');
            const positionsTableBody = document.querySelector('#positionsTable tbody');
            const historyTableBody = document.querySelector('#historyTable tbody');
            
            // Define padding and margins. Increased left padding for price labels.
            const padding = 60;

            // --- Initialization ---
            document.addEventListener('DOMContentLoaded', () => {
                canvas = document.getElementById('chartCanvas');
                ctx = canvas.getContext('2d');
                
                // This is a key fix: We must set the canvas dimensions from JavaScript
                // to make sure the drawing area is not 0x0.
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        if(entry.target.id === 'chartCanvas') {
                            chartWidth = entry.contentRect.width;
                            chartHeight = entry.contentRect.height;
                            canvas.width = chartWidth;
                            canvas.height = chartHeight;
                            if (stockData.length > 0) {
                                drawChart();
                            }
                        }
                    }
                });
                resizeObserver.observe(canvas);

                // Parse all data immediately and set the date picker range
                allStockData = parseData(rawData);
                updateDatePickerRange(allStockData);
                hideMessage();
                updateStartButtonState();

                // Event Listeners
                nextDayBtn.addEventListener('click', () => stepDay(1));
                startGameBtn.addEventListener('click', startGame);

                // Add event listeners for validation logic
                datePicker.addEventListener('change', handleDateSelection);
                startFundsInput.addEventListener('input', updateStartButtonState);

                // Simulator event listeners
                minusBtn.addEventListener('click', () => adjustInvestmentAmount(-1000));
                plusBtn.addEventListener('click', () => adjustInvestmentAmount(1000));
                buyBtn.addEventListener('click', handleBuy);
                sellBtn.addEventListener('click', handleSell);

                // Mouse event listeners for crosshair and date display
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseleave', handleMouseLeave);
            });
            
            // --- Start Screen Logic ---
            function adjustInvestmentAmount(change) {
                let currentAmount = parseFloat(investAmountInput.value);
                let newAmount = currentAmount + change;
                if (newAmount >= 1000) {
                    investAmountInput.value = newAmount;
                }
            }

            // New function to handle date selection and validate
            function handleDateSelection() {
                const selectedDateStr = datePicker.value;
                const isDateValid = selectedDateStr && allStockData.some(day => {
                    const dataDate = new Date(day.date.getTime());
                    const dataDateStr = `${dataDate.getFullYear()}-${(dataDate.getMonth() + 1).toString().padStart(2, '0')}-${dataDate.getDate().toString().padStart(2, '0')}`;
                    return dataDateStr === selectedDateStr;
                });

                if (isDateValid) {
                    startMessageArea.classList.add('hidden');
                } else {
                    startMessageArea.textContent = 'Invalid end date. Please choose a valid trading day.';
                    startMessageArea.classList.remove('hidden');
                }
                updateStartButtonState();
            }

            function startGame() {
                const endDateStr = datePicker.value;
                const initialFunds = parseFloat(startFundsInput.value);
                
                // Find the index of the selected end date in the full dataset
                const endIndex = allStockData.findIndex(d => {
                    const dataDate = new Date(d.date.getTime());
                    const dataDateStr = `${dataDate.getFullYear()}-${(dataDate.getMonth() + 1).toString().padStart(2, '0')}-${dataDate.getDate().toString().padStart(2, '0')}`;
                    return dataDateStr === endDateStr;
                });

                if (endIndex === -1) {
                    startMessageArea.textContent = 'Could not find the selected end date. Please try again.';
                    startMessageArea.classList.remove('hidden');
                    return;
                }

                // Slice the full dataset to the selected end date to create the game's data
                stockData = allStockData.slice(0, endIndex + 1);

                // Initialize game state
                startFunds = initialFunds;
                remainingFunds = initialFunds;
                totalInvestedAmount = 0;
                totalRealizedPnL = 0;
                portfolio = {};
                transactionHistory = [];
                currentIndex = 0;
                
                // Switch screens
                startScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                
                // Initialize game UI and draw the first day's chart
                updateSimulatorButtons();
                updatePortfolioValues();
                renderPortfolio();
                renderHistory();
                drawChart();
            }

            function updateStartButtonState() {
                 const dateSelected = datePicker.value !== '';
                 const fundsEntered = parseFloat(startFundsInput.value) > 0;
                 const isReady = dateSelected && fundsEntered;
                 
                 startGameBtn.disabled = !isReady;
                 if (isReady) {
                     startGameBtn.classList.remove('bg-gray-600', 'disabled-btn');
                     startGameBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                 } else {
                     startGameBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                     startGameBtn.classList.add('bg-gray-600', 'disabled-btn');
                 }
            }

            // --- Data Processing and Parsing ---
            function parseData(text) {
                const lines = text.trim().split('\n').slice(1);
                return lines.map(line => {
                    const parts = line.split(',');
                    const dateStr = parts[2];
                    const date = new Date(dateStr.substring(0, 4), dateStr.substring(4, 6) - 1, dateStr.substring(6, 8));
                    
                    return {
                        date: date,
                        stock: parts[0],
                        open: parseFloat(parts[4]),
                        high: parseFloat(parts[5]),
                        low: parseFloat(parts[6]),
                        close: parseFloat(parts[7])
                    };
                }).filter(item => !isNaN(item.open) && !isNaN(item.high) && !isNaN(item.low) && !isNaN(item.close));
            }
            
            // This function now takes the specific stock data as an argument
            function updateDatePickerRange(data) {
                if (data.length > 0) {
                    const firstDate = data[0].date;
                    const lastDate = data[data.length - 1].date;
                    datePicker.min = formatDate(firstDate);
                    datePicker.max = formatDate(lastDate);
                    // Reset the value to ensure it's within the new range
                    datePicker.value = '';
                }
            }
            
            function stepDay(direction) {
                const newIndex = currentIndex + direction;
                if (newIndex >= 0 && newIndex < stockData.length) {
                    currentIndex = newIndex;
                    drawChart();
                }
                updateSimulatorButtons();
            }
            
            // --- Chart Drawing Logic ---
            function drawChart() {
                // Clear the canvas for a fresh drawing
                ctx.clearRect(0, 0, chartWidth, chartHeight);
                
                // Ensure there is data to draw and that the canvas has dimensions
                if (stockData.length === 0 || chartWidth === 0 || chartHeight === 0) return;

                // Display all data up to the current day
                dataToDisplay = stockData.slice(0, currentIndex + 1);
                if (dataToDisplay.length === 0) return;

                // Find min/max prices to scale the chart
                const prices = dataToDisplay.flatMap(d => [d.high, d.low]);
                maxPrice = Math.max(...prices);
                minPrice = Math.min(...prices);
                
                // Add a small buffer to the top and bottom of the chart
                const pricePadding = (maxPrice - minPrice) * 0.1;
                const chartAreaWidth = chartWidth - padding * 2;
                const chartAreaHeight = chartHeight - padding * 2;

                priceScale = chartAreaHeight / ((maxPrice - minPrice) + 2 * pricePadding);
                const dateScale = chartAreaWidth / dataToDisplay.length;

                // Draw the axes
                ctx.strokeStyle = '#6b7280';
                ctx.beginPath();
                ctx.moveTo(padding, chartHeight - padding);
                ctx.lineTo(chartWidth - padding, chartHeight - padding);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, chartHeight - padding);
                ctx.stroke();

                let previousMonth = -1;
                let previousYear = -1;
                dataToDisplay.forEach((day, index) => {
                    const x = padding + index * dateScale + dateScale / 2;
                    const openY = chartHeight - padding - (day.open - minPrice + pricePadding) * priceScale;
                    const highY = chartHeight - padding - (day.high - minPrice + pricePadding) * priceScale;
                    const lowY = chartHeight - padding - (day.low - minPrice + pricePadding) * priceScale;
                    const closeY = chartHeight - padding - (day.close - minPrice + pricePadding) * priceScale;

                    const isBullish = day.close >= day.open;
                    ctx.strokeStyle = isBullish ? '#10b981' : '#ef4444';
                    ctx.fillStyle = isBullish ? '#10b981' : '#ef4444';

                    // Draw the vertical line (high-low)
                    ctx.beginPath();
                    ctx.moveTo(x, highY);
                    ctx.lineTo(x, lowY);
                    ctx.stroke();

                    // Draw the candle body
                    const bodyHeight = Math.abs(openY - closeY) || 1;
                    const bodyWidth = Math.max(1, dateScale * 0.7); // Ensure body has a minimum width
                    ctx.fillRect(x - bodyWidth / 2, Math.min(openY, closeY), bodyWidth, bodyHeight);

                    const currentMonth = day.date.getMonth();
                    const currentYear = day.date.getFullYear();
                    
                    // Draw month lines and labels
                    if (index > 0 && currentMonth !== previousMonth) {
                        ctx.strokeStyle = '#4b5563';
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(x, padding);
                        ctx.lineTo(x, chartHeight - padding);
                        ctx.stroke();
                        ctx.setLineDash([]);

                        ctx.fillStyle = '#9ca3af';
                        ctx.font = '10px Inter, sans-serif';
                        ctx.textAlign = 'center';
                        const dateText = `${monthNames[currentMonth]}`;
                        ctx.fillText(dateText, x, chartHeight - padding + 20);
                    }

                    // Draw year lines and labels
                    if (index > 0 && currentYear !== previousYear) {
                        ctx.fillStyle = '#9ca3af';
                        ctx.font = '12px Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(currentYear, x, chartHeight - padding + 40);
                    }

                    previousMonth = currentMonth;
                    previousYear = currentYear;
                });

                // Draw price labels
                ctx.fillStyle = '#9ca3af';
                ctx.font = '10px Inter, sans-serif';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                const yAxisLabels = 5;
                for (let i = 0; i <= yAxisLabels; i++) {
                    const price = minPrice + pricePadding + (maxPrice - minPrice) * (i / yAxisLabels);
                    const y = chartHeight - padding - (price - minPrice + pricePadding) * priceScale;
                    ctx.fillText(price.toFixed(2), padding - 10, y);
                }
                
                // Update the liquidation value based on the latest day's closing price
                if (dataToDisplay.length > 0) {
                     updateLiquidationValue(dataToDisplay[dataToDisplay.length - 1].close);
                     displayClosePrice(dataToDisplay[dataToDisplay.length - 1].close);
                }
            }

            // --- Crosshair and Date/Price Display Logic ---
            let crosshairX, crosshairY;

            function handleMouseMove(event) {
                if (stockData.length === 0) return;
                const rect = canvas.getBoundingClientRect();
                crosshairX = event.clientX - rect.left;
                crosshairY = event.clientY - rect.top;

                const chartAreaX = crosshairX >= padding && crosshairX <= chartWidth - padding;
                const chartAreaY = crosshairY >= padding && crosshairY <= chartHeight - padding;

                if (chartAreaX && chartAreaY) {
                    drawChart();
                    const dataIndex = getNearestCandleIndex(crosshairX);
                    if (dataIndex !== -1) {
                        const snappedX = getCandleXPosition(dataIndex);
                        drawCrosshair(snappedX, crosshairY);
                        displayCrosshairInfo(snappedX, crosshairY, dataIndex);
                        updateLiquidationValue(dataToDisplay[dataIndex].close);
                    } else {
                         handleMouseLeave();
                    }
                } else {
                    handleMouseLeave();
                }
            }

            function handleMouseLeave() {
                drawChart();
                crosshairDateEl.style.opacity = 0;
                crosshairPriceEl.style.opacity = 0;
                crosshairClosePriceEl.style.opacity = 0;
                
                if (dataToDisplay.length > 0) {
                     updateLiquidationValue(dataToDisplay[dataToDisplay.length - 1].close);
                     displayClosePrice(dataToDisplay[dataToDisplay.length - 1].close);
                }
            }

            function drawCrosshair(x, y) {
                ctx.setLineDash([2, 2]);
                ctx.strokeStyle = '#ffffff';

                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, chartHeight - padding);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(chartWidth - padding, y);
                ctx.stroke();

                ctx.setLineDash([]);
            }

            function displayCrosshairInfo(x, y, dataIndex) {
                const day = dataToDisplay[dataIndex];
                const formattedDate = formatCrosshairDate(day.date);
                crosshairDateEl.textContent = formattedDate;
                crosshairDateEl.style.left = `${x}px`;
                crosshairDateEl.style.opacity = 1;

                const price = yToPrice(y);
                crosshairPriceEl.textContent = price.toFixed(2);
                crosshairPriceEl.style.top = `${y}px`;
                crosshairPriceEl.style.opacity = 1;
            }

            function displayClosePrice(price) {
                crosshairClosePriceEl.textContent = `Close: ${price.toFixed(2)}`;
                crosshairClosePriceEl.style.opacity = 1;
            }

            function formatCrosshairDate(date) {
                const d = new Date(date);
                const day = String(d.getDate()).padStart(2, '0');
                const month = monthNames[d.getMonth()];
                const year = d.getFullYear();
                return `${day}-${month}-${year}`;
            }

            function getNearestCandleIndex(x) {
                const chartAreaWidth = chartWidth - padding * 2;
                const dateScale = chartAreaWidth / dataToDisplay.length;
                const index = Math.floor((x - padding) / dateScale);
                if (index >= 0 && index < dataToDisplay.length) {
                    return index;
                }
                return -1;
            }

            function getCandleXPosition(index) {
                const chartAreaWidth = chartWidth - padding * 2;
                const dateScale = chartAreaWidth / dataToDisplay.length;
                return padding + index * dateScale + dateScale / 2;
            }
            
            function priceToY(price) {
                const pricePadding = (maxPrice - minPrice) * 0.1;
                return chartHeight - padding - (price - minPrice + pricePadding) * priceScale;
            }

            function yToPrice(y) {
                const chartAreaHeight = chartHeight - padding * 2;
                const pricePadding = (maxPrice - minPrice) * 0.1;
                const relativeY = chartHeight - padding - y;
                const priceRange = (maxPrice - minPrice) + 2 * pricePadding;
                const price = (relativeY / chartAreaHeight) * priceRange + minPrice - pricePadding;
                return price;
            }

            // --- Simulator Logic ---
            function handleBuy() {
                if (stockData.length === 0 || currentIndex === -1) return;
                const currentDay = stockData[currentIndex];
                const currentPrice = currentDay.close;
                const maxInvestment = parseFloat(investAmountInput.value);
                
                if (currentPrice <= 0 || maxInvestment <= 0 || isNaN(maxInvestment)) return;

                const sharesToBuy = Math.floor(maxInvestment / currentPrice);
                if (sharesToBuy === 0) {
                     console.log("Maximum investment is too small to buy even one share.");
                    return;
                }

                const cost = sharesToBuy * currentPrice;
                const stock = currentDay.stock;

                if (cost > remainingFunds) {
                    console.log("Not enough funds to buy shares.");
                    return;
                }

                if (portfolio[stock]) {
                    // Update existing position
                    const currentShares = portfolio[stock].shares;
                    const currentCost = currentShares * portfolio[stock].avgPrice;
                    const newTotalShares = currentShares + sharesToBuy;
                    const newTotalCost = currentCost + cost;
                    const newAvgPrice = newTotalCost / newTotalShares;
                    
                    portfolio[stock].shares = newTotalShares;
                    portfolio[stock].avgPrice = newAvgPrice;
                } else {
                    // Create new position
                    portfolio[stock] = {
                        shares: sharesToBuy,
                        avgPrice: currentPrice
                    };
                }

                totalInvestedAmount += cost;
                remainingFunds -= cost;
                
                // Add to history
                transactionHistory.push({
                    date: currentDay.date,
                    operation: 'Buy',
                    shares: sharesToBuy,
                    price: currentPrice,
                    realizedPnL: 0
                });

                updatePortfolioValues();
                renderPortfolio();
                renderHistory();
            }

            function handleSell() {
                if (stockData.length === 0 || currentIndex === -1) return;
                const currentDay = stockData[currentIndex];
                const currentPrice = currentDay.close;
                const stock = currentDay.stock;
                
                if (!portfolio[stock] || portfolio[stock].shares === 0) {
                    console.log("No shares to sell.");
                    return;
                }

                const sharesToSell = portfolio[stock].shares;
                const avgPrice = portfolio[stock].avgPrice;
                const gainLoss = (currentPrice - avgPrice) * sharesToSell;

                totalRealizedPnL += gainLoss;
                remainingFunds += currentPrice * sharesToSell;
                
                totalInvestedAmount -= sharesToSell * avgPrice;
                
                // Add to history
                transactionHistory.push({
                    date: currentDay.date,
                    operation: 'Sell',
                    shares: sharesToSell,
                    price: currentPrice,
                    realizedPnL: gainLoss
                });
                
                // Remove from portfolio
                delete portfolio[stock];

                updatePortfolioValues();
                renderPortfolio();
                renderHistory();
            }

            function updateLiquidationValue(currentPrice) {
                let openPositionsValue = 0;
                for (const stock in portfolio) {
                    openPositionsValue += portfolio[stock].shares * currentPrice;
                }
                liquidationValue = remainingFunds + openPositionsValue;
                updatePortfolioValues();
            }

            function updatePortfolioValues() {
                totalInvestedEl.textContent = `$${totalInvestedAmount.toFixed(2)}`;
                remainingFundsEl.textContent = `$${remainingFunds.toFixed(2)}`;
                liquidationValueEl.textContent = `$${liquidationValue.toFixed(2)}`;
                realizedPnLEl.textContent = `$${totalRealizedPnL.toFixed(2)}`;
                
                // Style the P&L text
                realizedPnLEl.classList.remove('text-red-500', 'text-green-500');
                if (totalRealizedPnL > 0) realizedPnLEl.classList.add('text-green-500');
                if (totalRealizedPnL < 0) realizedPnLEl.classList.add('text-red-500');

                liquidationValueEl.classList.remove('text-red-500', 'text-green-500');
                if (liquidationValue > startFunds) liquidationValueEl.classList.add('text-green-500');
                if (liquidationValue < startFunds) liquidationValueEl.classList.add('text-red-500');
            }

            function renderPortfolio() {
                positionsTableBody.innerHTML = '';
                for (const stock in portfolio) {
                    const position = portfolio[stock];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${stock}</td>
                        <td>${position.shares.toFixed(0)}</td>
                        <td>$${position.avgPrice.toFixed(2)}</td>
                    `;
                    positionsTableBody.appendChild(row);
                }
            }

            function renderHistory() {
                historyTableBody.innerHTML = '';
                // Render in reverse chronological order
                [...transactionHistory].reverse().forEach(movement => {
                    const row = document.createElement('tr');
                    let pnlColorClass = '';
                    if (movement.operation === 'Sell') {
                        if (movement.realizedPnL > 0) pnlColorClass = 'text-green-500';
                        if (movement.realizedPnL < 0) pnlColorClass = 'text-red-500';
                    }
                    row.innerHTML = `
                        <td>${formatDate(movement.date)}</td>
                        <td>${movement.operation}</td>
                        <td>${movement.shares.toFixed(0)}</td>
                        <td>$${movement.price.toFixed(2)}</td>
                        <td class="${pnlColorClass}">$${movement.realizedPnL.toFixed(2)}</td>
                    `;
                    historyTableBody.appendChild(row);
                });
            }

            // --- UI Helpers ---
            function formatDate(date) {
                if (!date) return '';
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function updateSimulatorButtons() {
                if (currentIndex >= stockData.length - 1) {
                    nextDayBtn.disabled = true;
                    buyBtn.disabled = true;
                    sellBtn.disabled = true;
                } else {
                    nextDayBtn.disabled = false;
                    buyBtn.disabled = false;
                    sellBtn.disabled = false;
                }
            }

            function showMessage(msg) {
                messageArea.classList.remove('hidden');
                messageArea.querySelector('p').textContent = msg;
                if(nextDayBtn) nextDayBtn.disabled = true;
                if(buyBtn) buyBtn.disabled = true;
                if(sellBtn) sellBtn.disabled = true;
            }

            function hideMessage() {
                messageArea.classList.add('hidden');
            }
        })();
    </script>
</body>
</html>
