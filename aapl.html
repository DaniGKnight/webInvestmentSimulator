<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Simulator</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #2d3748;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .container {
            max-width: 90vw;
            margin: 0 auto;
        }
        #crosshair-date {
            position: absolute;
            bottom: 0px;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background-color: rgba(45, 55, 72, 0.8);
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #e2e8f0;
            pointer-events: none;
            display: none;
        }
        /* Style for disabled buttons */
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="p-4">
    <div class="container bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col lg:flex-row gap-6">
        <!-- Simulator Controls -->
        <div class="w-full lg:w-1/4 space-y-4">
            <h1 class="text-3xl font-bold mb-4 text-center text-white">Investment Simulator</h1>
            
            <!-- Date Navigation -->
            <div class="bg-gray-700 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold mb-2 text-white">Date Navigation</h2>
                <div class="flex items-center space-x-2 mb-2">
                    <label for="date-picker" class="block text-sm font-medium text-gray-400">Current Date:</label>
                    <input type="date" id="date-picker" class="flex-grow rounded-md bg-gray-800 text-white border border-gray-600 px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="prev-day-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">Previous Day</button>
                    <button id="next-day-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">Next Day</button>
                    <button id="last-day-btn" class="col-span-2 btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">Go to Last Day</button>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <button id="range-30d-btn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">30 Days</button>
                    <button id="range-90d-btn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">90 Days</button>
                </div>
            </div>

            <!-- Portfolio Status -->
            <div class="bg-gray-700 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold mb-2 text-white">Portfolio</h2>
                <div class="space-y-2">
                    <p class="text-gray-300"><span class="font-bold">Cash:</span> <span id="cash-balance" class="text-green-400">$10,000.00</span></p>
                    <p class="text-gray-300"><span class="font-bold">Shares Owned:</span> <span id="shares-owned" class="text-yellow-400">0</span></p>
                    <p class="text-gray-300"><span class="font-bold">Stock Value:</span> <span id="stock-value" class="text-blue-400">$0.00</span></p>
                    <p class="text-gray-300"><span class="font-bold">Total Portfolio:</span> <span id="total-portfolio" class="text-purple-400">$10,000.00</span></p>
                </div>
            </div>
            
            <!-- Trade Actions -->
            <div class="bg-gray-700 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold mb-2 text-white">Trade Actions</h2>
                <div class="flex space-x-2">
                    <input type="number" id="trade-quantity" value="1" min="1" class="w-2/3 rounded-md bg-gray-800 text-white border border-gray-600 px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="buy-btn" class="btn w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">Buy</button>
                </div>
                <button id="sell-btn" class="btn mt-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">Sell</button>
            </div>
        </div>

        <!-- Chart and Message Area -->
        <div class="w-full lg:w-3/4 flex flex-col relative bg-gray-800 rounded-xl p-4">
            <div id="message-area" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-700 text-white p-6 rounded-lg z-10 shadow-xl text-center">
                <p class="text-lg font-semibold"></p>
                <button id="reload-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Reload</button>
            </div>
            <div class="flex-grow relative">
                <canvas id="stock-chart" class="w-full h-full"></canvas>
                <div id="crosshair-date"></div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // --- Global Variables and DOM Elements ---
            const chartCanvas = document.getElementById('stock-chart');
            const chartCtx = chartCanvas.getContext('2d');
            const datePicker = document.getElementById('date-picker');
            const prevDayBtn = document.getElementById('prev-day-btn');
            const nextDayBtn = document.getElementById('next-day-btn');
            const lastDayBtn = document.getElementById('last-day-btn');
            const rangeButtons = document.querySelectorAll('#range-30d-btn, #range-90d-btn');
            const buyBtn = document.getElementById('buy-btn');
            const sellBtn = document.getElementById('sell-btn');
            const tradeQuantityInput = document.getElementById('trade-quantity');
            const cashBalanceEl = document.getElementById('cash-balance');
            const sharesOwnedEl = document.getElementById('shares-owned');
            const stockValueEl = document.getElementById('stock-value');
            const totalPortfolioEl = document.getElementById('total-portfolio');
            const messageArea = document.getElementById('message-area');
            const reloadBtn = document.getElementById('reload-btn');
            const crosshairDateEl = document.getElementById('crosshair-date');

            // --- Embedded Stock Data (Replaced file fetch) ---
            const stockData = [
                { "date": "2024-01-01", "open": 100.00, "high": 102.50, "low": 99.50, "close": 101.20, "volume": 150000 },
                { "date": "2024-01-02", "open": 101.20, "high": 103.00, "low": 100.80, "close": 102.80, "volume": 180000 },
                { "date": "2024-01-03", "open": 102.80, "high": 104.50, "low": 102.00, "close": 103.90, "volume": 220000 },
                { "date": "2024-01-04", "open": 103.90, "high": 103.50, "low": 101.50, "close": 102.10, "volume": 190000 },
                { "date": "2024-01-05", "open": 102.10, "high": 105.00, "low": 101.80, "close": 104.50, "volume": 250000 },
                { "date": "2024-01-06", "open": 104.50, "high": 106.20, "low": 103.80, "close": 105.90, "volume": 210000 },
                { "date": "2024-01-07", "open": 105.90, "high": 105.50, "low": 102.50, "close": 103.10, "volume": 170000 },
                { "date": "2024-01-08", "open": 103.10, "high": 104.80, "low": 102.90, "close": 104.20, "volume": 195000 },
                { "date": "2024-01-09", "open": 104.20, "high": 106.00, "low": 103.50, "close": 105.50, "volume": 230000 },
                { "date": "2024-01-10", "open": 105.50, "high": 107.10, "low": 105.00, "close": 106.80, "volume": 260000 },
                { "date": "2024-01-11", "open": 106.80, "high": 106.50, "low": 104.00, "close": 104.90, "volume": 200000 },
                { "date": "2024-01-12", "open": 104.90, "high": 105.80, "low": 104.20, "close": 105.50, "volume": 180000 },
                { "date": "2024-01-13", "open": 105.50, "high": 107.50, "low": 105.10, "close": 107.00, "volume": 240000 },
                { "date": "2024-01-14", "open": 107.00, "high": 107.80, "low": 106.50, "close": 107.20, "volume": 215000 },
                { "date": "2024-01-15", "open": 107.20, "high": 109.00, "low": 106.80, "close": 108.50, "volume": 280000 }
            ];

            // --- Simulation State Variables ---
            let currentIndex = 0;
            let portfolio = {
                cash: 10000,
                shares: 0,
            };

            // --- Chart Drawing Configuration ---
            const chartPadding = 40;
            const volumeHeight = 50;
            const chartWidth = chartCanvas.width;
            const chartHeight = chartCanvas.height;

            // --- Core Functions ---

            // Initial setup and data loading
            function initSimulator() {
                if (stockData.length === 0) {
                    showMessage("Error: No stock data available. Please provide a valid data source.");
                    return;
                }
                
                currentIndex = stockData.length - 1;
                updateSimulator();
                addEventListeners();
                hideMessage();
            }

            // Updates the simulator state and UI based on the current index
            function updateSimulator() {
                const currentData = stockData[currentIndex];
                datePicker.value = currentData.date;
                updatePortfolio();
                updateButtonStates();
                drawChart(currentIndex);
            }

            // Updates portfolio stats on the UI
            function updatePortfolio() {
                const currentPrice = stockData[currentIndex].close;
                const stockValue = portfolio.shares * currentPrice;
                const totalPortfolio = portfolio.cash + stockValue;
                cashBalanceEl.textContent = `$${portfolio.cash.toFixed(2)}`;
                sharesOwnedEl.textContent = portfolio.shares;
                stockValueEl.textContent = `$${stockValue.toFixed(2)}`;
                totalPortfolioEl.textContent = `$${totalPortfolio.toFixed(2)}`;
            }

            // Draws the candlestick and volume chart
            function drawChart(currentDayIndex) {
                // Resize canvas to fit container
                chartCanvas.width = chartCanvas.offsetWidth;
                chartCanvas.height = chartCanvas.offsetHeight;
                const width = chartCanvas.width;
                const height = chartCanvas.height;

                chartCtx.clearRect(0, 0, width, height);

                const visibleRange = 90; // Default to 90 days for initial view
                const startIndex = Math.max(0, currentDayIndex - visibleRange + 1);
                const visibleData = stockData.slice(startIndex, currentDayIndex + 1);

                if (visibleData.length === 0) return;

                // Calculate price and volume ranges
                const prices = visibleData.flatMap(d => [d.open, d.high, d.low, d.close]);
                const maxPrice = Math.max(...prices);
                const minPrice = Math.min(...prices);
                const maxVolume = Math.max(...visibleData.map(d => d.volume));

                // Drawing axes and labels
                drawAxisLabels(width, height, maxPrice, minPrice, maxVolume);

                const chartAreaHeight = height - chartPadding - volumeHeight;
                const candleWidth = (width - chartPadding) / visibleData.length;

                // Draw candlesticks and volume bars
                visibleData.forEach((day, i) => {
                    const x = chartPadding + i * candleWidth;
                    const priceYScale = (height - chartPadding - volumeHeight) / (maxPrice - minPrice);
                    const volumeYScale = volumeHeight / maxVolume;

                    // Draw candlestick
                    const openY = height - chartPadding - (day.open - minPrice) * priceYScale;
                    const closeY = height - chartPadding - (day.close - minPrice) * priceYScale;
                    const highY = height - chartPadding - (day.high - minPrice) * priceYScale;
                    const lowY = height - chartPadding - (day.low - minPrice) * priceYScale;
                    const isUp = day.close > day.open;
                    const color = isUp ? '#10b981' : '#ef4444'; // Green or Red

                    // Draw main body
                    chartCtx.fillStyle = color;
                    chartCtx.fillRect(x + candleWidth * 0.1, Math.min(openY, closeY), candleWidth * 0.8, Math.abs(openY - closeY) || 1);

                    // Draw wick
                    chartCtx.strokeStyle = color;
                    chartCtx.lineWidth = 1;
                    chartCtx.beginPath();
                    chartCtx.moveTo(x + candleWidth / 2, highY);
                    chartCtx.lineTo(x + candleWidth / 2, lowY);
                    chartCtx.stroke();

                    // Draw volume bar
                    const volumeY = height - chartPadding + 2; // +2 for a small gap
                    const volumeHeightScaled = day.volume * volumeYScale;
                    chartCtx.fillStyle = color;
                    chartCtx.fillRect(x + candleWidth * 0.1, volumeY, candleWidth * 0.8, -volumeHeightScaled);

                    // Draw the current day's vertical line
                    if (startIndex + i === currentDayIndex) {
                        chartCtx.strokeStyle = '#60a5fa'; // Blue
                        chartCtx.setLineDash([5, 5]);
                        chartCtx.beginPath();
                        chartCtx.moveTo(x + candleWidth / 2, 0);
                        chartCtx.lineTo(x + candleWidth / 2, height - chartPadding);
                        chartCtx.stroke();
                        chartCtx.setLineDash([]);
                    }
                });
            }

            // Draws price and date labels
            function drawAxisLabels(width, height, maxPrice, minPrice, maxVolume) {
                chartCtx.font = '12px Inter';
                chartCtx.fillStyle = '#e2e8f0';
                chartCtx.textAlign = 'right';

                // Price labels
                for (let i = 0; i <= 4; i++) {
                    const price = minPrice + (maxPrice - minPrice) * (i / 4);
                    const y = height - chartPadding - (height - chartPadding - volumeHeight) * (i / 4);
                    chartCtx.fillText(`$${price.toFixed(2)}`, chartPadding - 5, y);
                }

                // Volume labels
                chartCtx.textAlign = 'right';
                const volY = height - chartPadding;
                chartCtx.fillText('Volume', chartPadding - 5, volY - volumeHeight - 5);
                chartCtx.fillText(`${(maxVolume / 1000).toFixed(0)}K`, chartPadding - 5, volY - volumeHeight + 15);
                chartCtx.fillText('0', chartPadding - 5, volY + 5);
            }

            // Handles resizing the canvas
            function resizeCanvas() {
                chartCanvas.width = chartCanvas.offsetWidth;
                chartCanvas.height = chartCanvas.offsetHeight;
                updateSimulator();
            }

            // --- Event Handlers and Listeners ---

            function addEventListeners() {
                // Resize listener
                window.addEventListener('resize', resizeCanvas);

                // Date Picker Change
                datePicker.addEventListener('change', () => {
                    const newDate = datePicker.value;
                    const newIndex = stockData.findIndex(d => d.date === newDate);
                    if (newIndex !== -1) {
                        currentIndex = newIndex;
                        updateSimulator();
                    }
                });

                // Navigation Buttons
                prevDayBtn.addEventListener('click', () => {
                    if (currentIndex > 0) {
                        currentIndex--;
                        updateSimulator();
                    }
                });

                nextDayBtn.addEventListener('click', () => {
                    if (currentIndex < stockData.length - 1) {
                        currentIndex++;
                        updateSimulator();
                    }
                });

                lastDayBtn.addEventListener('click', () => {
                    currentIndex = stockData.length - 1;
                    updateSimulator();
                });

                // Range Buttons
                rangeButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        let days;
                        if (e.target.id === 'range-30d-btn') {
                            days = 30;
                        } else if (e.target.id === 'range-90d-btn') {
                            days = 90;
                        }
                        const startIndex = Math.max(0, currentIndex - days + 1);
                        drawChartWithRange(startIndex, currentIndex);
                    });
                });

                // Buy and Sell
                buyBtn.addEventListener('click', () => {
                    const currentPrice = stockData[currentIndex].close;
                    const quantity = parseInt(tradeQuantityInput.value, 10);
                    if (quantity > 0 && portfolio.cash >= quantity * currentPrice) {
                        portfolio.cash -= quantity * currentPrice;
                        portfolio.shares += quantity;
                        updatePortfolio();
                    }
                });

                sellBtn.addEventListener('click', () => {
                    const currentPrice = stockData[currentIndex].close;
                    const quantity = parseInt(tradeQuantityInput.value, 10);
                    if (quantity > 0 && portfolio.shares >= quantity) {
                        portfolio.shares -= quantity;
                        portfolio.cash += quantity * currentPrice;
                        updatePortfolio();
                    }
                });

                // Chart interactivity for crosshair
                chartCanvas.addEventListener('mousemove', (e) => {
                    const rect = chartCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left - chartPadding;
                    const width = chartCanvas.width;
                    const visibleRange = 90;
                    const startIndex = Math.max(0, currentIndex - visibleRange + 1);

                    const totalDays = currentIndex - startIndex + 1;
                    const candleWidth = (width - chartPadding) / totalDays;
                    const hoveredIndex = Math.floor(x / candleWidth);
                    
                    if (hoveredIndex >= 0 && hoveredIndex < totalDays) {
                        const dataIndex = startIndex + hoveredIndex;
                        const hoveredData = stockData[dataIndex];
                        crosshairDateEl.textContent = hoveredData.date;
                        crosshairDateEl.style.display = 'block';
                        crosshairDateEl.style.left = `${e.clientX - rect.left}px`;
                        
                        // Redraw chart with crosshair
                        drawChart(currentIndex);
                        drawCrosshair(e.clientX - rect.left, e.clientY - rect.top);
                    } else {
                        crosshairDateEl.style.display = 'none';
                        drawChart(currentIndex); // Redraw without crosshair
                    }
                });

                chartCanvas.addEventListener('mouseleave', () => {
                    crosshairDateEl.style.display = 'none';
                    drawChart(currentIndex);
                });

                // Reload button
                reloadBtn.addEventListener('click', () => {
                    location.reload();
                });
            }

            function drawCrosshair(x, y) {
                const width = chartCanvas.width;
                const height = chartCanvas.height;
                
                chartCtx.strokeStyle = '#60a5fa';
                chartCtx.lineWidth = 1;
                chartCtx.setLineDash([2, 2]);

                // Vertical line
                chartCtx.beginPath();
                chartCtx.moveTo(x, 0);
                chartCtx.lineTo(x, height);
                chartCtx.stroke();

                // Horizontal line
                chartCtx.beginPath();
                chartCtx.moveTo(0, y);
                chartCtx.lineTo(width, y);
                chartCtx.stroke();
                
                chartCtx.setLineDash([]);
            }

            // Function to draw chart with a specified range
            function drawChartWithRange(start, end) {
                const visibleData = stockData.slice(start, end + 1);
                
                if (visibleData.length === 0) return;

                // Calculate price and volume ranges for the specific view
                const prices = visibleData.flatMap(d => [d.open, d.high, d.low, d.close]);
                const maxPrice = Math.max(...prices);
                const minPrice = Math.min(...prices);
                const maxVolume = Math.max(...visibleData.map(d => d.volume));

                // Clear and redraw for the specified range
                chartCtx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                drawAxisLabels(chartCanvas.width, chartCanvas.height, maxPrice, minPrice, maxVolume);

                const width = chartCanvas.width;
                const height = chartCanvas.height;
                const chartAreaHeight = height - chartPadding - volumeHeight;
                const candleWidth = (width - chartPadding) / visibleData.length;

                visibleData.forEach((day, i) => {
                    const x = chartPadding + i * candleWidth;
                    const priceYScale = chartAreaHeight / (maxPrice - minPrice);
                    const volumeYScale = volumeHeight / maxVolume;

                    // Draw candlestick
                    const openY = height - chartPadding - (day.open - minPrice) * priceYScale;
                    const closeY = height - chartPadding - (day.close - minPrice) * priceYScale;
                    const highY = height - chartPadding - (day.high - minPrice) * priceYScale;
                    const lowY = height - chartPadding - (day.low - minPrice) * priceYScale;
                    const isUp = day.close > day.open;
                    const color = isUp ? '#10b981' : '#ef4444';

                    chartCtx.fillStyle = color;
                    chartCtx.fillRect(x + candleWidth * 0.1, Math.min(openY, closeY), candleWidth * 0.8, Math.abs(openY - closeY) || 1);

                    chartCtx.strokeStyle = color;
                    chartCtx.lineWidth = 1;
                    chartCtx.beginPath();
                    chartCtx.moveTo(x + candleWidth / 2, highY);
                    chartCtx.lineTo(x + candleWidth / 2, lowY);
                    chartCtx.stroke();

                    // Draw volume bar
                    const volumeY = height - chartPadding + 2;
                    const volumeHeightScaled = day.volume * volumeYScale;
                    chartCtx.fillStyle = color;
                    chartCtx.fillRect(x + candleWidth * 0.1, volumeY, candleWidth * 0.8, -volumeHeightScaled);
                });
            }

            // Initial call to start the app
            window.onload = initSimulator;

        })();
    </script>
</body>
</html>
